dist: trusty
sudo: required
services:
- docker

env:
  global:
  - CONTAINER_NAME=debian_container
  - CONTAINER_EXEC="docker exec -t debian_container"
  - secure: "OTCiJgdIj/yukkMSyPXzA9/wdubW3SnGABtPuA7D0QNVqZX1crwLwPrnhGdI1dN/BMVo/kmsBDmQtZA3AcFEo1XFmJ134QTBaToptXIqL6PZTb2zelOFJ6rQSK+mwmvr6+HMQbqy8c1wRrytDKlPaq+oLbFJEvmXx/UqrPoLuCY="
  matrix:
  - VARIANT=jessie-mips
  - VARIANT=jessie-mipsel
  - VARIANT=jessie-powerpc
  - VARIANT=sid-mips
  - VARIANT=sid-mips64el
  - VARIANT=sid-mipsel
  - VARIANT=sid-powerpc
  - VARIANT=stretch-mips
  - VARIANT=stretch-mips64el
  - VARIANT=stretch-mipsel
  - VARIANT=wheezy-mips
  - VARIANT=wheezy-mipsel
  - VARIANT=wheezy-powerpc

matrix:
  fast_finish: true
  exclude:
  - env: VARIANT=jessie-kfreebsd-amd64
  - env: VARIANT=jessie-kfreebsd-i386
  - env: VARIANT=sid-hurd-i386
  - env: VARIANT=sid-kfreebsd-amd64
  - env: VARIANT=sid-kfreebsd-i386
  - env: VARIANT=wheezy-ia64
  - env: VARIANT=wheezy-kfreebsd-amd64
  - env: VARIANT=wheezy-kfreebsd-i386
  allow_failures:
  - env: VARIANT=wheezy-ia64
  - env: VARIANT=wheezy-s390
  - env: VARIANT=wheezy-sparc

branches:
  only:
  - master

before_install:
- sudo git clone --depth 1 -b mips-force-ipv4-apt https://github.com/vicamo/docker.git "${TRAVIS_BUILD_DIR%${TRAVIS_REPO_SLUG}}/docker"
- ln -sf "${TRAVIS_BUILD_DIR%${TRAVIS_REPO_SLUG}}/docker/contrib/mkimage.sh" ./mkimage.sh
- |
  sudo docker run -d -i -t --name ${CONTAINER_NAME} \
    --privileged -v /var/run/docker.sock:/var/run/docker.sock \
    -v ${TRAVIS_BUILD_DIR%${TRAVIS_REPO_SLUG}}:${TRAVIS_BUILD_DIR%${TRAVIS_REPO_SLUG}} \
    debian:sid /bin/bash
- ${CONTAINER_EXEC} apt update -qq
- |
  ${CONTAINER_EXEC} apt install --no-install-recommends -y \
    binfmt-support binutils curl debian-archive-keyring debootstrap docker.io \
    make qemu-user-static sudo xz-utils

script:
- ${CONTAINER_EXEC} make -C "${TRAVIS_BUILD_DIR}" V=1 NO_SKIP=1 DOCKER_USER=${DOCKER_USER} -j $(nproc) all-$VARIANT
- cat ${VARIANT%-*}/${VARIANT#*-}/rootfs/debootstrap/debootstrap.log
- docker images | grep ^${DOCKER_USER}/$(cat repo) | awk '{print $1 ":" $2}'

after_success:
- if [ "${TRAVIS_PULL_REQUEST}" == "false" ]; then
    docker login -u "${DOCKER_USER}" -p "${DOCKER_PASS}";
    for image in $(docker images | grep ^${DOCKER_USER}/$(cat repo) | awk '{print $1 ":" $2}'); do
      docker push $image;
    done
  fi
